# IPグッズ在庫管理システム システム構成図

## 1. システムアーキテクチャ概要

### 1.1 全体構成
```
┌─────────────────────────────────────────────────────────────────┐
│                          インターネット                             │
└────────────────────────────┬────────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │  ロードバランサー │
                    │   (AWS ALB)      │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────┴───────┐   ┌───────┴───────┐   ┌───────┴───────┐
│   Web Server   │   │   Web Server   │   │   Web Server   │
│   (Nginx)      │   │   (Nginx)      │   │   (Nginx)      │
│   ┌─────────┐ │   │   ┌─────────┐ │   │   ┌─────────┐ │
│   │Frontend │ │   │   │Frontend │ │   │   │Frontend │ │
│   │(React)  │ │   │   │(React)  │ │   │   │(React)  │ │
│   └─────────┘ │   │   └─────────┘ │   │   └─────────┘ │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
                    ┌────────┴────────┐
                    │  API Gateway    │
                    │  (Kong/AWS API) │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────┴───────┐   ┌───────┴───────┐   ┌───────┴───────┐
│  App Server   │   │  App Server   │   │  App Server   │
│  (Node.js)    │   │  (Node.js)    │   │  (Node.js)    │
│  Express API  │   │  Express API  │   │  Express API  │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
                ┌────────────┼────────────┐
                │            │            │
        ┌───────┴───────┐   │   ┌────────┴────────┐
        │  PostgreSQL   │   │   │     Redis       │
        │   Primary     │   │   │    (Cache)      │
        └───────┬───────┘   │   └─────────────────┘
                │           │
        ┌───────┴───────┐   │   ┌─────────────────┐
        │  PostgreSQL   │   │   │   S3 Bucket     │
        │   Replica     │   │   │  (File Storage) │
        └───────────────┘   │   └─────────────────┘
                            │
                            │   ┌─────────────────┐
                            └───│ Elasticsearch   │
                                │  (Search/Log)   │
                                └─────────────────┘
```

## 2. 技術スタック

### 2.1 フロントエンド
- **フレームワーク**: React 18.x
- **状態管理**: Redux Toolkit
- **UIライブラリ**: Material-UI (MUI) v5
- **ルーティング**: React Router v6
- **HTTP通信**: Axios
- **リアルタイム通信**: Socket.io-client
- **QRコード**: react-qr-scanner
- **グラフ**: Chart.js
- **ビルドツール**: Vite

### 2.2 バックエンド
- **言語**: Node.js 18.x
- **フレームワーク**: Express.js
- **ORM**: Prisma
- **認証**: Passport.js + JWT
- **バリデーション**: Joi
- **ロギング**: Winston
- **ジョブキュー**: Bull
- **WebSocket**: Socket.io
- **テスト**: Jest

### 2.3 インフラストラクチャ
- **クラウド**: AWS
- **コンテナ**: Docker
- **オーケストレーション**: Amazon ECS
- **CI/CD**: GitHub Actions
- **監視**: CloudWatch + Datadog
- **CDN**: CloudFront

### 2.4 データベース・ストレージ
- **RDB**: PostgreSQL 14
- **キャッシュ**: Redis 7
- **検索エンジン**: Elasticsearch 8
- **ファイルストレージ**: Amazon S3
- **バックアップ**: AWS Backup

## 3. ネットワーク構成

### 3.1 VPC設計
```
┌─────────────────────────────────────────────────────────────┐
│                     VPC (10.0.0.0/16)                       │
│                                                             │
│  ┌─────────────────────────┐  ┌─────────────────────────┐ │
│  │  Public Subnet          │  │  Public Subnet          │ │
│  │  (10.0.1.0/24)         │  │  (10.0.2.0/24)         │ │
│  │  ┌─────────────────┐   │  │  ┌─────────────────┐   │ │
│  │  │   NAT Gateway   │   │  │  │   NAT Gateway   │   │ │
│  │  └─────────────────┘   │  │  └─────────────────┘   │ │
│  └───────────┬─────────────┘  └───────────┬─────────────┘ │
│              │                             │                │
│  ┌───────────┴─────────────┐  ┌───────────┴─────────────┐ │
│  │  Private Subnet         │  │  Private Subnet         │ │
│  │  (10.0.11.0/24)        │  │  (10.0.12.0/24)        │ │
│  │  ┌─────────────────┐   │  │  ┌─────────────────┐   │ │
│  │  │   App Servers   │   │  │  │   App Servers   │   │ │
│  │  └─────────────────┘   │  │  └─────────────────┘   │ │
│  └─────────────────────────┘  └─────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────┐  ┌─────────────────────────┐ │
│  │  Private Subnet (DB)    │  │  Private Subnet (DB)    │ │
│  │  (10.0.21.0/24)        │  │  (10.0.22.0/24)        │ │
│  │  ┌─────────────────┐   │  │  ┌─────────────────┐   │ │
│  │  │   PostgreSQL    │   │  │  │   PostgreSQL    │   │ │
│  │  │    Primary      │   │  │  │    Replica      │   │ │
│  │  └─────────────────┘   │  │  └─────────────────┘   │ │
│  └─────────────────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 セキュリティグループ
- **ALB**: 80, 443 (インターネットから)
- **Web/App**: 3000 (ALBから)
- **DB**: 5432 (Appから)
- **Redis**: 6379 (Appから)

## 4. デプロイメント構成

### 4.1 コンテナ構成
```yaml
# docker-compose.yml (開発環境)
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    
  backend:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://redis:6379
    
  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=goods_stock
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
    
  redis:
    image: redis:7-alpine
```

### 4.2 本番環境デプロイフロー
```
1. GitHub Push
2. GitHub Actions 起動
3. Docker Build
4. ECR Push
5. ECS Task Definition 更新
6. Blue/Green Deployment
7. Health Check
8. 切り替え完了
```

## 5. 監視・ログ構成

### 5.1 監視項目
- **アプリケーション**
  - レスポンスタイム
  - エラー率
  - スループット
  - 同時接続数

- **インフラストラクチャ**
  - CPU使用率
  - メモリ使用率
  - ディスク使用率
  - ネットワーク帯域

- **ビジネスメトリクス**
  - 在庫更新頻度
  - ユーザーアクティビティ
  - アラート発生数

### 5.2 ログ収集
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Application │────▶│  CloudWatch │────▶│Elasticsearch│
│    Logs     │     │    Logs     │     │   (分析)    │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 6. バックアップ・災害復旧

### 6.1 バックアップ戦略
- **データベース**: 日次フルバックアップ + 継続的アーカイブ
- **ファイル**: S3 クロスリージョンレプリケーション
- **設定**: AWS Systems Manager Parameter Store

### 6.2 復旧目標
- **RPO (Recovery Point Objective)**: 1時間
- **RTO (Recovery Time Objective)**: 4時間

## 7. 開発環境

### 7.1 ローカル開発環境
```
開発者PC
├── Docker Desktop
├── Node.js 18.x
├── PostgreSQL 14 (Docker)
├── Redis (Docker)
└── VS Code / WebStorm
```

### 7.2 開発フロー
1. Feature Branch作成
2. ローカル開発
3. Unit Test実行
4. Pull Request作成
5. Code Review
6. CI/CD自動テスト
7. Staging環境デプロイ
8. 本番環境デプロイ

## 8. セキュリティ構成

### 8.1 アプリケーションセキュリティ
- JWT認証
- HTTPS通信
- CORS設定
- Rate Limiting
- SQLインジェクション対策
- XSS対策

### 8.2 インフラセキュリティ
- WAF (AWS WAF)
- DDoS対策 (AWS Shield)
- 暗号化 (転送時/保存時)
- VPCプライベートサブネット
- セキュリティグループ
- NACLs

## 9. パフォーマンス最適化

### 9.1 フロントエンド
- コード分割 (Code Splitting)
- 遅延ローディング
- 画像最適化 (WebP)
- Service Worker
- CDN活用

### 9.2 バックエンド
- データベースインデックス
- クエリ最適化
- Redis キャッシング
- コネクションプーリング
- 非同期処理