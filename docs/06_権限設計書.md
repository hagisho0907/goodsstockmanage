# IPグッズ在庫管理システム 権限設計書

## 1. 概要

### 1.1 権限管理方針
- **RBAC（Role-Based Access Control）**を採用
- 最小権限の原則に基づく設計
- 職務分離の実現
- 拠点別アクセス制御の実装

### 1.2 権限の階層構造
```
システム管理者（最上位）
    ↓
マネージャー
    ↓
在庫管理者
    ↓
倉庫作業員
    ↓
閲覧者（最下位）
```

## 2. ロール定義

### 2.1 システム管理者（system_admin）
**概要**: システム全体の管理権限を持つ最上位ロール

**主な権限**:
- 全機能へのフルアクセス
- ユーザー管理（作成・編集・削除・権限変更）
- システム設定の変更
- マスターデータの管理
- 監査ログの閲覧
- データのバックアップ・リストア

### 2.2 マネージャー（manager）
**概要**: 業務全体を統括し、レポート分析や承認を行うロール

**主な権限**:
- 全商品データの閲覧・編集
- 入出庫承認
- レポート作成・閲覧
- アラート設定の管理
- 棚卸しの承認
- 部下の作業履歴確認

### 2.3 在庫管理者（inventory_manager）
**概要**: 日常的な在庫管理業務の中心的なロール

**主な権限**:
- 商品登録・編集・削除
- 入出庫処理
- 棚卸し実施
- QRコード・バーコード生成
- 在庫レポート閲覧
- 申し送り事項の作成・編集

### 2.4 倉庫作業員（warehouse_staff）
**概要**: 現場での入出庫作業に特化したロール

**主な権限**:
- 入出庫処理（スキャン）
- 在庫確認
- 棚卸し作業参加
- 申し送り事項の閲覧・追加
- 自身の作業履歴確認

### 2.5 営業担当者（sales_staff）
**概要**: 在庫情報の確認と顧客対応に必要な情報アクセス

**主な権限**:
- 在庫数の確認
- 商品情報の閲覧
- 販売可能地域・期間の確認
- 出庫予定の確認
- レポート閲覧（限定）

### 2.6 閲覧者（viewer）
**概要**: 情報確認のみ可能な最小権限ロール

**主な権限**:
- 在庫数の確認
- 商品基本情報の閲覧
- 公開レポートの閲覧

## 3. 機能別権限マトリックス

| 機能 | システム管理者 | マネージャー | 在庫管理者 | 倉庫作業員 | 営業担当者 | 閲覧者 |
|------|---------------|-------------|-----------|-----------|-----------|--------|
| **商品管理** |
| 商品登録 | ✓ | ✓ | ✓ | - | - | - |
| 商品編集 | ✓ | ✓ | ✓ | - | - | - |
| 商品削除 | ✓ | ✓ | ✓ | - | - | - |
| 商品閲覧 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| IP情報編集 | ✓ | ✓ | ✓ | - | - | - |
| **在庫管理** |
| 入庫処理 | ✓ | ✓ | ✓ | ✓ | - | - |
| 出庫処理 | ✓ | ✓ | ✓ | ✓ | - | - |
| 在庫調整 | ✓ | ✓ | ✓ | - | - | - |
| 在庫確認 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| **QR/バーコード** |
| コード生成 | ✓ | ✓ | ✓ | - | - | - |
| コード読取 | ✓ | ✓ | ✓ | ✓ | - | - |
| **棚卸し** |
| 棚卸し作成 | ✓ | ✓ | ✓ | - | - | - |
| 棚卸し実施 | ✓ | ✓ | ✓ | ✓ | - | - |
| 棚卸し承認 | ✓ | ✓ | - | - | - | - |
| **アラート** |
| アラート設定 | ✓ | ✓ | ✓ | - | - | - |
| アラート確認 | ✓ | ✓ | ✓ | ✓ | ✓ | - |
| **レポート** |
| レポート作成 | ✓ | ✓ | ✓ | - | - | - |
| レポート閲覧 | ✓ | ✓ | ✓ | △ | △ | △ |
| レポート出力 | ✓ | ✓ | ✓ | - | △ | - |
| **申し送り** |
| 申し送り作成 | ✓ | ✓ | ✓ | ✓ | - | - |
| 申し送り編集 | ✓ | ✓ | ✓ | △ | - | - |
| 申し送り閲覧 | ✓ | ✓ | ✓ | ✓ | ✓ | - |
| **ユーザー管理** |
| ユーザー作成 | ✓ | △ | - | - | - | - |
| ユーザー編集 | ✓ | △ | - | - | - | - |
| ユーザー削除 | ✓ | - | - | - | - | - |
| 権限変更 | ✓ | △ | - | - | - | - |
| **システム設定** |
| マスタ管理 | ✓ | △ | - | - | - | - |
| システム設定 | ✓ | - | - | - | - | - |
| 監査ログ閲覧 | ✓ | △ | - | - | - | - |

**凡例**: ✓ 完全アクセス / △ 制限付きアクセス / - アクセス不可

## 4. 拠点別アクセス制御

### 4.1 拠点制限の概要
ユーザーは所属拠点のデータのみアクセス可能（デフォルト）

### 4.2 拠点権限の種類
```json
{
  "location_access": {
    "type": "single|multiple|all",
    "locations": ["tokyo", "osaka", "nagoya"],
    "cross_location_view": true|false
  }
}
```

### 4.3 拠点別権限マトリックス
| ロール | 自拠点 | 他拠点閲覧 | 他拠点編集 | 全拠点 |
|--------|--------|-----------|-----------|--------|
| システム管理者 | ✓ | ✓ | ✓ | ✓ |
| マネージャー | ✓ | ✓ | △ | △ |
| 在庫管理者 | ✓ | △ | - | - |
| 倉庫作業員 | ✓ | - | - | - |
| 営業担当者 | ✓ | ✓ | - | - |
| 閲覧者 | ✓ | △ | - | - |

## 5. データアクセス権限

### 5.1 商品情報の可視性
| データ項目 | システム管理者 | マネージャー | 在庫管理者 | 倉庫作業員 | 営業担当者 | 閲覧者 |
|-----------|---------------|-------------|-----------|-----------|-----------|--------|
| 基本情報 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 在庫数 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 原価情報 | ✓ | ✓ | △ | - | - | - |
| IP契約情報 | ✓ | ✓ | ✓ | - | △ | - |
| 入出庫履歴 | ✓ | ✓ | ✓ | △ | △ | - |
| 申し送り | ✓ | ✓ | ✓ | ✓ | ✓ | - |

### 5.2 個人情報アクセス
- 他ユーザーの個人情報は管理権限を持つロールのみ閲覧可能
- 自身の情報は全ロールで閲覧・一部編集可能

## 6. 権限の実装詳細

### 6.1 権限チェックの実装箇所
1. **API層**: 各エンドポイントで権限検証
2. **ビジネスロジック層**: 重要処理前の権限確認
3. **UI層**: 権限に応じた表示制御

### 6.2 権限情報の保持
```json
{
  "user": {
    "id": "user-uuid",
    "roles": ["inventory_manager"],
    "locations": ["tokyo", "osaka"],
    "permissions": {
      "products.create": true,
      "products.edit": true,
      "products.delete": true,
      "inventory.adjust": true
    }
  }
}
```

## 7. 権限変更・承認フロー

### 7.1 権限変更プロセス
1. 権限変更申請（上長承認必要）
2. システム管理者による最終承認
3. 変更履歴の記録
4. 本人への通知

### 7.2 一時的権限付与
- 期間限定の権限昇格
- 代理作業用の一時権限
- 自動失効機能

## 8. セキュリティ考慮事項

### 8.1 権限昇格の防止
- セッション固定化攻撃対策
- 権限変更時の再認証
- 監査ログの記録

### 8.2 職務分離の原則
- 登録者と承認者の分離
- 作業者と検証者の分離
- 相互牽制の実現

## 9. 権限設定例

### 9.1 東京倉庫の在庫管理者
```json
{
  "name": "山田太郎",
  "email": "yamada@example.com",
  "roles": ["inventory_manager"],
  "locations": ["tokyo"],
  "permissions": {
    "products.*": true,
    "inventory.*": true,
    "reports.view": true,
    "reports.create": true,
    "cross_location_view": false
  }
}
```

### 9.2 全国統括マネージャー
```json
{
  "name": "鈴木花子",
  "email": "suzuki@example.com",
  "roles": ["manager"],
  "locations": ["all"],
  "permissions": {
    "products.*": true,
    "inventory.*": true,
    "reports.*": true,
    "users.view": true,
    "cross_location_view": true,
    "cross_location_edit": true
  }
}
```

## 10. 監査・コンプライアンス

### 10.1 アクセスログ記録項目
- ユーザーID・ロール
- アクセス日時
- 実行操作
- アクセス対象データ
- IPアドレス
- 成功/失敗

### 10.2 定期的な権限レビュー
- 四半期ごとの権限棚卸し
- 不要権限の削除
- 異動・退職時の権限剥奪